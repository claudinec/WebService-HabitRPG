#!/usr/bin/perl
use v5.10.0;
use strict;
use warnings;
use WebService::HabitRPG;
use Config::Tiny;
use Data::Dumper;

# PODNAME: hrpg

# VERSION

if (not @ARGV) {
    say q{
    Usage:

    hrpg dump                    : Dump entire user info
    hrpg status                  : Show current HP/XP/GP
    hrpg tasks                   : Show current tasks
    hrpg habit|daily|reward|todo : Show tasks of current type
    };

    exit 1;
}

# TODO: Support XDG?
my $config_file = "$ENV{HOME}/.habitrpgrc";

my $config = Config::Tiny->read( $config_file );

unless ($config->{auth}{api_token}) {
    die "Cannot find user credentials in $config_file\n";
}

my $hrpg = WebService::HabitRPG->new(
    api_token => $config->{auth}{api_token},
    user_id   => $config->{auth}{user_id},
);

my $cmd = shift @ARGV;

given ($cmd) {
    when ('dump')   { say Dumper $hrpg->user; }

    when ('status') {
        my $user = $hrpg->user;
        say "Hark, $user->{profile}{name}! (Lv $user->{stats}{lvl})";
        say "HP: $user->{stats}{hp} / $user->{stats}{maxHealth}";
        say "XP: $user->{stats}{exp} / $user->{stats}{toNextLevel}";
        say "GP: $user->{stats}{gp}";
    }

    when (/^(?<type>habit|todo|daily|reward)$/) {
        my $tasks = $hrpg->user_tasks($+{type});
        say Dumper $tasks;
    }

    when ('tasks') {
        my $tasks = $hrpg->user_tasks();
        say Dumper $tasks;
    }

}
